#!/bin/sh

#### Options
Private=0
Help=0

while getopts hp o; do
  case "$o" in
    h) echo "hinit [-hp]"; exit 0;;
    p) Private=1;;
  esac
done

shift $(( OPTIND - 1 ));

OS=$(uname -s)
USER=${1:-pgollucci}
THOME=/tmp/$USER

case $OS in
  Darwin) HOME=/Users/$USER ;;
  **) HOME=/home/$USER
esac

#### Main Setup
echo "Creating Staging Area"
sudo rm -rf $THOME
sudo mkdir $THOME
sudo chown $USER $THOME

echo "Cloning Repos"
git clone -q git@github.com:pgollucci/home.git          $THOME

# ruby
git clone -q git@github.com:postmodern/ruby-install.git $THOME/.repos/langs/ruby-install
git clone -q git@github.com:sstephenson/rbenv.git       $THOME/.repos/langs/rbenv
mkdir -p $THOME/.repos/langs/rbenv/plugins
git clone -q git@github.com:sstephenson/ruby-build.git  $THOME/.repos/langs/rbenv/plugins/ruby-build

# perl
git clone git@github.com/tokuhirom/plenv.git            $THOME/.repos/langs/.plenv
mkdir -p $THOME/.repos/langs/plenv/plugins
git clone git@github.com/tokuhirom/Perl-Build.git       $THOME/.repos/langs/plenv/plugins/perl-build

# python
git clone git@github.com/yyuu/pyenv.git                 $THOME/.repos/langs/pyenv

echo "Transfering"
rsync -atz --delete $THOME/ $HOME/

echo "Cleaning"
rm -rf $THOME

#### Private Repo
echo "Private bits"
( cd $HOME ; git clone -q git@github.com:pgollucci/home-private.git $HOME/.private )
if [ $Private -eq 1 ]; then
  cd $HOME/.ssh
  ln -s $HOME/.private/ssh/2/id* .
  chmod 600 $HOME/.private/ssh/2/id*
fi

echo "SSH Pub Keys"
cat $HOME/.private/ssh/2/id*.pub >> $HOME/.ssh/authorized_keys

if [ $Private -ne 1 ]; then
  rm -rf $HOME/.private
fi

echo "Set Owners"
chown -Rh $USER $HOME

echo "Done"
