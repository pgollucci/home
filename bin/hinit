#!/bin/sh -e

usage() {

    echo "hinit [-cDhp]"
    echo "TEST: bin/hinit"
    echo "RUN: bin/hinit -cD"
    echo <<END_U
-c        Clean:   delete files no longer in git or known excludes (rsync --delete) , Default SAVE FILES
-D        Dry:     overwrite HOME, Default DO NOT OVERWRITE (rsync -n)
-h        Help:    display this message
-p        Private: install private things too (never on remote computer)
END_U

    exit 0
}

main() {

    #### Options
    Clean=
    Dry=-n
    Help=0
    Private=0

    while getopts cDhp o; do
	case "$o" in
	    c) Clean="--delete" ;;
	    D) Dry="" ;;
	    h) usage ;;
	    p) Private=1 ;;
	esac
    done

    shift $(( OPTIND - 1 ));

    OS=$(uname -s)
    USER=${1:-$USER}
    group=$USER
    THOME=/tmp/$USER
    SUDO=sudo

    case $OS in
	*CYGWIN*)
	    SUDO=
	    HOME=/home/$USER
	    ;;
	Darwin)
	    HOME=/Users/$USER
	    group=staff
	    ;;
	**)
	    HOME=/home/$USER
	    ;;
    esac

    #### Main Setup
    echo "Creating Staging Area"
    $SUDO rm -rf $THOME
    $SUDO mkdir $THOME
    $SUDO chown $USER $THOME

    echo "Dirs"
    mkdir $THOME/.zcache

    # XXX: duplicated
    P6_SRC_DIR=$THOME/dev/src
    P6_SRC_GH_DIR=$P6_SRC_DIR/github.com
    P6_SRC_ASF_DIR=$P6_SRC_DIR/apache.org
    P6_SRC_FBSD_DIR=$P6_SRC_DIR/freebsd.org
    P6_SRC_ME_DIR=$P6_SRC_GH_DIR/$USER

    mkdir -p $P6_SRC_GH_DIR $P6_SRC_ASF_DIR $P6_SRC_FBSD_DIR $P6_SRC_ME_DIR
    mkdir -p $P6_SRC_GH_DIR/rbenv/plugins
    mkdir -p $P6_SRC_GH_DIR/plenv/plugins
    mkdir -p $P6_SRC_GH_DIR/Renv/plugins
    mkdir -p $P6_SRC_GH_DIR/luaenv/plugins

    GH_URL=https://github.com

    echo "Cloning Repos"

    echo "home"
    git clone -q $GH_URL/pgollucci/home.git          $THOME

    echo "emacs"
    git clone -q $GH_URL/pgollucci/emacs.git         $P6_SRC_ME_DIR/emacs
    git clone -q $GH_URL/magnars/.emacs.d.git        $P6_SRC_GH_DIR/magnars/.emacs.d

    echo "Ruby"
    git clone -q $GH_URL/sstephenson/rbenv.git       $P6_SRC_GH_DIR/rbenv
    git clone -q $GH_URL/sstephenson/ruby-build.git  $P6_SRC_GH_DIR/ruby-build

    echo "Perl"
    git clone -q $GH_URL/tokuhirom/plenv.git         $P6_SRC_GH_DIR/plenv
    git clone -q $GH_URL/tokuhirom/Perl-Build.git    $P6_SRC_GH_DIR/plenv/plugins/perl-build

    echo "Python"
    git clone -q $GH_URL/yyuu/pyenv.git              $P6_SRC_GH_DIR/pyenv
    git clone -q $GH_URL/pyenv/pyenv-virtualenv.git  $P6_SRC_GH_DIR/pyenv-virtualenv

    echo "Go"
    git clone -q $GH_URL/wfarr/goenv.git             $P6_SRC_GH_DIR/goenv

    echo "Java"
    git clone -q $GH_URL/gcuisinier/jenv.git         $P6_SRC_GH_DIR/jenv

    echo "R"
    git clone -q $GH_URL/viking/Renv.git             $P6_SRC_GH_DIR/Renv
    git clone -q $GH_URL/viking/R-build.git          $P6_SRC_GH_DIR/R-build

    echo "Scala"
    git clone -q $GH_URL/scalaenv/scalaenv.git       $P6_SRC_GH_DIR/scalaenv

    echo "Lua"
    git clone -q $GH_URL/cehoffman/luaenv.git        $P6_SRC_GH_DIR/luaenv
    git clone -q $GH_URL/cehoffman/lua-build.git     $P6_SRC_GH_DIR/lua-build

    echo "zplug"
    git clone -q $GH_URL/b4b4r07/zplug.git           $P6_SRC_GH_DIR/zsh/zplug

    echo "zpresto"
    git clone -q $GH_URL/sorin-ionescu/prezto.git    $P6_SRC_GH_DIR/zsh/zprezto

    echo "Transfering"
    $SUDO rsync \
	  -atz $Dry $Clean \
	  --exclude Applications \
	  --exclude Desktop \
	  --exclude Documents \
	  --exclude Downloads \
	  --exclude Dropbox \
	  --exclude Google\ Drive \
	  --exclude OneDrive\* \
	  --exclude Library \
	  --exclude Movies \
	  --exclude Music \
	  --exclude Pictures \
	  --exclude Public \
	  --exclude dev \
	  --exclude perl5 \
	  --exclude tmp \
	  --exclude .ssh/dynamic \
	  --exclude .Trash \
	  $THOME/ $HOME/

    # symklink
    (cd $HOME ; ln -s dev/src/github.com/pgollucci/emacs .emacs.d)
    (cd $HOME/.emacs.d/defuns ; ln -s $HOME/dev/src/github.com/magnars/.emacs.d/defuns/* .)

    #### Private Repo
    if [ $Private -eq 1 ]; then
        echo "Private bits"
        ( cd $HOME ; git clone -q $GH_URL/$USER/home-private.git $HOME/.private )
	(
	    cd $HOME/.ssh
	    ln -s $HOME/.private/ssh/2/id* .
	    chmod 600 $HOME/.private/ssh/2/id*
	)

	mkdir $HOME/.aws
	(cd $HOME/.aws ; ln -s .private/aws/map-$USER .)

        echo "SSH Pub Keys"
        cat $HOME/.private/ssh/2/id*.pub >> $HOME/.ssh/authorized_keys

	rm -rf $HOME/.private
    fi

    echo "Set Owners"
    $SUDO chown -Rh $USER:$group $HOME

    echo "Done"
}

main "$@"
