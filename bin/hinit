#!/bin/sh

#### Options
Private=0
Help=0

while getopts hp o; do
  case "$o" in
    h) echo "hinit [-hp]"; exit 0;;
    p) Private=1;;
  esac
done

shift $(( OPTIND - 1 ));

OS=$(uname -s)
USER=${1:-pgollucci}
THOME=/tmp/$USER
case $OS in
  Darwin) HOME=/Users/$USER ;;
  **) HOME=/home/$USER
esac

#### Main Setup
echo "Creating Staging Area"
sudo rm -rf $THOME
sudo mkdir $THOME
sudo chown $USER $THOME

echo "Cloning Repos"
git clone -q git@github.com:pgollucci/home.git          $THOME
git clone -q git@github.com:pgollucci/dotfiles.git      $THOME/.dotfiles
git clone -q git@github.com:robbyrussell/oh-my-zsh.git  $THOME/.oh-my-zsh
( cd $THOME/.dotfiles/ ; git submodule -q update -q --init --recursive )

echo "Transfering"
rsync -atz --delete $THOME/ $HOME/

echo "Cleaning"
rm -rf $THOME

#### Private Repo
echo "Private bits"
( cd $HOME ; git clone -q git@github.com:pgollucci/home-private.git $HOME/.private )
if [ $Private -eq 1 ]; then
  cd $HOME/.ssh
  ln -s $HOME/.private/ssh/2/id* .
  chmod 600 $HOME/.private/ssh/2/id*
fi

echo "SSH Pub Keys"
cat $HOME/.private/ssh/2/id*.pub >> $HOME/.ssh/authorized_keys

if [ $Private -ne 1 ]; then
  rm -rf $HOME/.private
fi

echo "Set Owners"
chown -Rh $USER $HOME

echo "Done"
