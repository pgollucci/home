#!/bin/sh -x

USER=pgollucci
THOME=/tmp/$USER
HOME=/home/pgollucci

#### Options
Private=0
Help=0

while getopts hp o; do
  case "$o" in
    h) echo "hinit [-hp]"; exit 0;;
    p) Private=1;;
  esac
done

#### Main Setup
sudo mkdir $THOME
sudo chown $USER $THOME
git clone git@github.com:pgollucci/home.git 		$THOME
git clone git@github.com:pgollucci/dotfiles.git 	$THOME/.dotfiles
git clone git@github.com:pgollucci/oh-my-zsh.git 	$THOME/.oh-my-zsh
git clone git@github.com:pgollucci/rbenv.git 		$THOME/.rbenv

cd $THOME/.rbenv
git submodule update --init --recursive >/dev/null

cd $THOME/.dotfiles/
git submodule update --init --recursive >/dev/null

rsync -avtz --delete $THOME/ $HOME/
rm -rf $THOME

#### Private Repo
cd $HOME
git clone git@github.com:pgollucci/home-private.git 	$HOME/.private
if [ $Private -eq 1 ]; then
  cd $HOME/.ssh
  ln -s $HOME/.private/ssh/id* .
  chmod 600 $HOME/.private/ssh/id*
fi

cat $HOME/.private/ssh/id*.pub >> $HOME/.ssh/authorized_keys

if [ $Private -ne 1 ]; then
  rm -rf $HOME/.private
fi

# symlinks
chown -Rh $USER $HOME

grep -l /tmp/$USER $HOME |xargs perl -pi -e "s,/tmp/pgollucci,$HOME,g"

echo "Done"
