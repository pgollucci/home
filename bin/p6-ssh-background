#!/usr/bin/env zsh -x

usage() {
    echo "p6-ssh-background args"
    exit 0
}

set_color_name() {
    local HOST=$1
    local HEX_FG=$2
    local HEX_BG=$3
    local OPACITY=$4

    local FG_R=`echo $HEX_FG | sed 's/../0x&,/g' | awk -F "," '{printf("%d",$1 * 257)}'`
    local FG_G=`echo $HEX_FG | sed 's/../0x&,/g' | awk -F "," '{printf("%d",$2 * 257)}'`
    local FG_B=`echo $HEX_FG | sed 's/../0x&,/g' | awk -F "," '{printf("%d",$3 * 257)}'`
    local BG_R=`echo $HEX_BG | sed 's/../0x&,/g' | awk -F "," '{printf("%d",$1 * 257)}'`
    local BG_G=`echo $HEX_BG | sed 's/../0x&,/g' | awk -F "," '{printf("%d",$2 * 257)}'`
    local BG_B=`echo $HEX_BG | sed 's/../0x&,/g' | awk -F "," '{printf("%d",$3 * 257)}'`

    /usr/bin/osascript <<EOF
tell application "iTerm"
   tell current session of current window
      set name to "$HOST"
      set foreground color to {$FG_R, $FG_G, $FG_B}
      set background color to {$BG_R, $BG_G, $BG_B}
      set transparency to "$OPACITY"
   end tell
end tell
EOF
}

colors_load() {

    red="fa053e"
    orange="fa6b05"
    yellow="dedb86"
    green="1c6928"
    dgreen="064a10"
    dblue="1a2261"
    blue="054cf2"
    cyan="3beaf6"
    purple="973bcc"
    lpurple="eb5bd5"
    pink="f213d5"
    lsalmon3="cd8162"
    brown="542323"
    black="000000"
    white="ffffff"
    opacity="0.0"
}

normalize() {
    local host="$1"

    echo $host | sed -e 's,\..*,,' -e 's,\.,_,g'
}

fg_for_host() {
    local host="$1"

    cat $HOME/.hosts | awk -v k=$host '$1 ~ k { print $3 }'
}

bg_for_host() {
    local host="$1"

    cat $HOME/.hosts | awk -v k=$host '$1 ~ k { print $2 }'
}

main() {
    local type="$1"
    local host="$2"

    local t_host=$(normalize "${host}")

    colors_load

    local fg=$(fg_for_host "$t_host")
    local bg=$(bg_for_host "$t_host")

    eval fg=\$$fg
    eval bg=\$$bg

    if [ -z "$fg" -o -z "$bg" ]; then
	echo "$host not found"
	return
    fi

    set_color_name "$t_host" "$fg" "$bg" "$opacity"
    case $type in
	ssh) ssh $host ;;
    esac
    set_color_name "$t_host" "$white" "$black" "$opacity"
}

main "$@"
