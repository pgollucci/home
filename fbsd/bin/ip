#!/usr/bin/env perl

use strict;
use warnings FATAL => 'all';
use Carp;

my %PARTS = (
    pkg_name    => 0,
    dir         => 1,
    prefix      => 2,
    comment     => 3,
    pkg_descr   => 4,
    maintainer  => 5,
    categories  => 6,
    ldep        => 7,
    rdep        => 8,
    lrdep       => 10,
    www         => 9,
);

my $index;
if ($ARGV[0] =~ /INDEX/) {
  $index = $ARGV[0];
  shift @ARGV;
}
else {
  $index = "/usr/local/poudriere/ports/head/INDEX-11";
}

die "$ARGV[0] is not a valid choice" if !exists $PARTS{$ARGV[0]};

open my $fh, '<', $index;
while (my $line = <$fh>) {
  my @parts = split /\|/, $line;
  $parts[1] =~ s,/usr/ports/,,g;
  if (($ARGV[0] =~ /lrdep/ && ($parts[7] =~ /$ARGV[1]/ || $parts[8] =~ /$ARGV[1]/)) || ($parts[$PARTS{$ARGV[0]}] =~ /$ARGV[1]/i)) {
    print $parts[1];
    print "/Makefile" if $ARGV[2] && $ARGV[2] eq 'M';
    print "/pkg-plist" if $ARGV[2] && $ARGV[2] eq 'P';
    print "/pkg-descr" if $ARGV[2] && $ARGV[2] eq 'D';
    print "\n";
  }
}
close $fh;
